#!/usr/bin/env python
"""
Script táº¡o vÃ  quáº£n lÃ½ password báº£o máº­t cao cho UnstressVN
Usage:
    python scripts/manage_passwords.py generate           # Táº¡o password má»›i
    python scripts/manage_passwords.py init               # Khá»Ÿi táº¡o default settings
    python scripts/manage_passwords.py show               # Hiá»ƒn thá»‹ settings (áº©n secret)
    python scripts/manage_passwords.py export             # Export settings ra file .env.example
    python scripts/manage_passwords.py update-postgres    # Cáº­p nháº­t password PostgreSQL
"""

import os
import sys
import string
import random
import argparse

# Setup Django
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'unstressvn_settings.settings')

import django
django.setup()

from core.models import SiteSettings, APIKey


def generate_secure_password(length=32, include_special=True):
    """Táº¡o password báº£o máº­t cao"""
    if length < 16:
        length = 16
    
    lowercase = string.ascii_lowercase
    uppercase = string.ascii_uppercase
    digits = string.digits
    special = '!@#$%^&*()_+-=[]{}|;:,.<>?' if include_special else ''
    
    # Ensure at least one of each type
    password = [
        random.choice(lowercase),
        random.choice(uppercase),
        random.choice(digits),
    ]
    
    if include_special:
        password.append(random.choice(special))
    
    # Fill the rest
    all_chars = lowercase + uppercase + digits + special
    remaining = length - len(password)
    password.extend(random.choice(all_chars) for _ in range(remaining))
    
    random.shuffle(password)
    return ''.join(password)


def cmd_generate(args):
    """Táº¡o password má»›i"""
    print("\nğŸ” Password Generator - UnstressVN")
    print("=" * 50)
    
    count = args.count or 5
    length = args.length or 32
    
    print(f"\nTáº¡o {count} password vá»›i Ä‘á»™ dÃ i {length} kÃ½ tá»±:\n")
    
    for i in range(count):
        password = generate_secure_password(length, not args.no_special)
        print(f"  {i+1}. {password}")
    
    print("\nğŸ’¡ Copy password vÃ  lÆ°u an toÃ n!")
    print()


def cmd_init(args):
    """Khá»Ÿi táº¡o default settings"""
    print("\nâš™ï¸ Khá»Ÿi táº¡o Site Settings")
    print("=" * 50)
    
    # Init site settings
    SiteSettings.init_default_settings()
    print("âœ… ÄÃ£ khá»Ÿi táº¡o Site Settings")
    
    # Init API keys
    created = APIKey.create_default_keys()
    if created:
        print(f"âœ… ÄÃ£ táº¡o API Keys: {', '.join(created)}")
    else:
        print("â„¹ï¸ API Keys Ä‘Ã£ tá»“n táº¡i")
    
    print("\nğŸ“‹ Settings hiá»‡n táº¡i:")
    for setting in SiteSettings.objects.all():
        value = "â—â—â—â—â—â—â—â—" if setting.is_secret else setting.value
        print(f"  â€¢ {setting.name}: {value}")
    
    print()


def cmd_show(args):
    """Hiá»ƒn thá»‹ táº¥t cáº£ settings"""
    print("\nğŸ“‹ Site Settings - UnstressVN")
    print("=" * 50)
    
    # Group by type
    for setting_type, type_name in SiteSettings.SETTING_TYPE_CHOICES:
        settings = SiteSettings.objects.filter(setting_type=setting_type)
        if settings.exists():
            print(f"\nğŸ”¹ {type_name}:")
            for s in settings:
                if s.is_secret and not args.show_secrets:
                    value = "â—â—â—â—â—â—â—â—"
                else:
                    value = s.value
                print(f"   {s.name}: {value}")
    
    print("\nğŸ”¹ API Keys:")
    for key in APIKey.objects.filter(is_active=True):
        if args.show_secrets:
            print(f"   {key.name}: {key.key}")
        else:
            print(f"   {key.name}: {key.key[:10]}...{key.key[-4:]}")
    
    if not args.show_secrets:
        print("\nğŸ’¡ ThÃªm --show-secrets Ä‘á»ƒ hiá»ƒn thá»‹ password Ä‘áº§y Ä‘á»§")
    print()


def cmd_export(args):
    """Export settings ra file .env.example"""
    print("\nğŸ“¤ Export Settings to .env")
    print("=" * 50)
    
    output_file = args.output or '.env.generated'
    
    lines = [
        "# UnstressVN Environment Variables",
        "# Generated by manage_passwords.py",
        f"# Date: {__import__('datetime').datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
        "",
        "# ============ Database ============",
    ]
    
    # Database settings
    db_settings = SiteSettings.objects.filter(setting_type='database')
    for s in db_settings:
        env_name = s.name.upper()
        lines.append(f"{env_name}={s.value}")
    
    lines.append("")
    lines.append("# ============ API Keys ============")
    
    for key in APIKey.objects.filter(is_active=True):
        env_name = key.name.upper()
        lines.append(f"{env_name}={key.key}")
    
    lines.append("")
    lines.append("# ============ Email ============")
    
    email_settings = SiteSettings.objects.filter(setting_type='email')
    for s in email_settings:
        env_name = s.name.upper()
        lines.append(f"{env_name}={s.value}")
    
    # Write to file
    with open(output_file, 'w') as f:
        f.write('\n'.join(lines))
    
    print(f"âœ… ÄÃ£ export ra: {output_file}")
    print(f"âš ï¸ LÆ°u Ã½: File nÃ y chá»©a password tháº­t, báº£o máº­t cáº©n tháº­n!")
    print()


def cmd_update_postgres(args):
    """Cáº­p nháº­t password PostgreSQL má»›i"""
    print("\nğŸ˜ Update PostgreSQL Password")
    print("=" * 50)
    
    new_password = generate_secure_password(32, include_special=False)  # No special for postgres
    
    print(f"\nğŸ” Password má»›i (khÃ´ng cÃ³ kÃ½ tá»± Ä‘áº·c biá»‡t): ")
    print(f"   {new_password}")
    
    print("\nğŸ“‹ CÃ¡c bÆ°á»›c cáº§n thá»±c hiá»‡n:")
    print("   1. Cáº­p nháº­t password trong PostgreSQL:")
    print(f"      sudo -u postgres psql -c \"ALTER USER unstressvn WITH PASSWORD '{new_password}';\"")
    print()
    print("   2. Cáº­p nháº­t file .env:")
    print(f"      DATABASE_PASSWORD={new_password}")
    print()
    print("   3. Restart server:")
    print("      ./stop.sh && ./start.sh")
    print()
    
    # Update in database if confirmed
    if args.apply:
        SiteSettings.set(
            name='postgres_password',
            value=new_password,
            setting_type='database',
            is_secret=True,
            description='PostgreSQL Password'
        )
        print("âœ… ÄÃ£ cáº­p nháº­t password trong SiteSettings")
    else:
        print("ğŸ’¡ ThÃªm --apply Ä‘á»ƒ lÆ°u password vÃ o database")
    print()


def main():
    parser = argparse.ArgumentParser(
        description='UnstressVN Password Manager',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    
    subparsers = parser.add_subparsers(dest='command', help='Commands')
    
    # generate command
    gen_parser = subparsers.add_parser('generate', help='Táº¡o password má»›i')
    gen_parser.add_argument('-n', '--count', type=int, default=5, help='Sá»‘ password táº¡o')
    gen_parser.add_argument('-l', '--length', type=int, default=32, help='Äá»™ dÃ i password')
    gen_parser.add_argument('--no-special', action='store_true', help='KhÃ´ng dÃ¹ng kÃ½ tá»± Ä‘áº·c biá»‡t')
    
    # init command
    subparsers.add_parser('init', help='Khá»Ÿi táº¡o default settings')
    
    # show command
    show_parser = subparsers.add_parser('show', help='Hiá»ƒn thá»‹ settings')
    show_parser.add_argument('--show-secrets', action='store_true', help='Hiá»ƒn thá»‹ password Ä‘áº§y Ä‘á»§')
    
    # export command
    export_parser = subparsers.add_parser('export', help='Export ra file .env')
    export_parser.add_argument('-o', '--output', help='Output file', default='.env.generated')
    
    # update-postgres command
    pg_parser = subparsers.add_parser('update-postgres', help='Táº¡o password PostgreSQL má»›i')
    pg_parser.add_argument('--apply', action='store_true', help='LÆ°u password vÃ o database')
    
    args = parser.parse_args()
    
    if args.command == 'generate':
        cmd_generate(args)
    elif args.command == 'init':
        cmd_init(args)
    elif args.command == 'show':
        cmd_show(args)
    elif args.command == 'export':
        cmd_export(args)
    elif args.command == 'update-postgres':
        cmd_update_postgres(args)
    else:
        parser.print_help()


if __name__ == '__main__':
    main()
