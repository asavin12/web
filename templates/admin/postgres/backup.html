{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}Database Backup{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="/admin/postgres/">PostgreSQL</a>
    &rsaquo; Backup
</div>
{% endblock %}

{% block content %}
<!-- Create Backup -->
<div class="module">
    <h2>T·∫°o Backup m·ªõi</h2>
    <table>
        <tbody>
            <tr>
                <th scope="row">Database:</th>
                <td><code>{{ db_name }}</code></td>
            </tr>
            <tr>
                <th scope="row">Size:</th>
                <td>{{ db_size }}</td>
            </tr>
        </tbody>
    </table>
    <div style="padding: 15px 0;">
        <form id="backupForm" method="post" style="display: inline;">
            {% csrf_token %}
            <input type="submit" value="üíæ T·∫°o Backup ngay" class="default" id="createBackupBtn">
        </form>
        <span id="backupStatus" style="margin-left: 15px;"></span>
    </div>
</div>

<!-- Existing Backups -->
<div class="module">
    <h2>Backups ƒë√£ t·∫°o ({{ backups|length }})</h2>
    {% if backups %}
    <table id="result_list">
        <thead>
            <tr>
                <th scope="col">Filename</th>
                <th scope="col">Size</th>
                <th scope="col">Created</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for backup in backups %}
            <tr class="{% cycle 'row1' 'row2' %}">
                <td><strong>{{ backup.filename }}</strong></td>
                <td>{{ backup.size }}</td>
                <td>{{ backup.created }}</td>
                <td>
                    <a href="?download={{ backup.filename }}" class="viewlink">Download</a>
                    |
                    <a href="#" onclick="deleteBackup('{{ backup.filename }}'); return false;" style="color: #ba2121;">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="padding: 20px; text-align: center; color: #666;">Ch∆∞a c√≥ backup n√†o. Click "T·∫°o Backup ngay" ƒë·ªÉ t·∫°o backup ƒë·∫ßu ti√™n.</p>
    {% endif %}
</div>

<!-- Restore Database -->
<div class="module">
    <h2 style="background: #79aec8;">üîÑ Restore Database</h2>
    <div style="padding: 15px;">
        <div style="padding: 10px 15px; background: #fff3cd; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
            <strong>‚ö†Ô∏è C·∫¢NH B√ÅO:</strong> Restore s·∫Ω <strong>ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i</strong>.
            H√£y t·∫°o backup tr∆∞·ªõc khi restore. Sau khi restore xong, b·∫°n c·∫ßn <strong>restart container</strong>
            (trong Coolify) ƒë·ªÉ load l·∫°i SiteConfiguration.
        </div>

        <!-- Tab buttons -->
        <div style="display: flex; gap: 0; margin-bottom: 0;">
            <button type="button" id="tabUpload" onclick="switchRestoreTab('upload')"
                style="padding: 8px 20px; background: #417690; color: #fff; border: 1px solid #417690; border-bottom: none; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 13px; font-weight: bold;">
                üì§ Upload file t·ª´ m√°y t√≠nh
            </button>
            <button type="button" id="tabServer" onclick="switchRestoreTab('server')"
                style="padding: 8px 20px; background: #e0e0e0; color: #333; border: 1px solid #ccc; border-bottom: none; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 13px; margin-left: -1px;">
                üìÇ Ch·ªçn file t·ª´ server
            </button>
        </div>

        <!-- Upload tab -->
        <div id="restoreUpload" style="border: 1px solid #417690; border-radius: 0 4px 4px 4px; padding: 20px;">
            <form id="restoreUploadForm" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 12px;">
                {% csrf_token %}
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Ch·ªçn file backup (.sql):</label>
                    <input type="file" name="backup_file" id="restoreFile" accept=".sql"
                        style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box;">
                </div>
                <div id="restoreFileInfo" style="display: none; padding: 8px 12px; background: #f0f0f0; border-radius: 4px; font-size: 13px;"></div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button type="submit" id="restoreUploadBtn" class="default" disabled
                        style="padding: 8px 20px; opacity: 0.5;">
                        üîÑ Restore t·ª´ file upload
                    </button>
                    <span id="restoreUploadStatus"></span>
                </div>
            </form>
        </div>

        <!-- Server file tab -->
        <div id="restoreServer" style="display: none; border: 1px solid #ccc; border-radius: 0 4px 4px 4px; padding: 20px;">
            {% if backups %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #ddd;">File</th>
                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #ddd;">Size</th>
                        <th style="text-align: left; padding: 8px; border-bottom: 2px solid #ddd;">Ng√†y t·∫°o</th>
                        <th style="text-align: center; padding: 8px; border-bottom: 2px solid #ddd;">Restore</th>
                    </tr>
                </thead>
                <tbody>
                    {% for backup in backups %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px;"><strong>{{ backup.filename }}</strong></td>
                        <td style="padding: 8px;">{{ backup.size }}</td>
                        <td style="padding: 8px;">{{ backup.created }}</td>
                        <td style="padding: 8px; text-align: center;">
                            <button type="button" onclick="restoreFromServer('{{ backup.filename }}')"
                                style="padding: 5px 14px; background: #e17009; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                üîÑ Restore
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="padding: 15px; text-align: center; color: #666;">
                Ch∆∞a c√≥ backup n√†o tr√™n server. T·∫°o backup tr∆∞·ªõc ho·∫∑c upload file t·ª´ m√°y t√≠nh.
            </p>
            {% endif %}
            <div id="restoreServerStatus" style="margin-top: 12px;"></div>
        </div>
    </div>
</div>

<!-- Media Files -->
<div class="module">
    <h2 style="background: #79aec8;">üìÅ Media Files</h2>
    <div style="padding: 15px;">
        <div style="display: flex; gap: 12px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
            <a href="/admin/postgres/media/download/" class="default"
               style="display: inline-block; padding: 8px 16px; background: #417690; color: #fff; border-radius: 4px; text-decoration: none; font-size: 13px;">
                üì• Download media (tar.gz)
            </a>
        </div>
        <div style="padding: 10px 15px; background: #e8f4fd; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #417690;">
            Upload file <strong>.tar.gz</strong> ho·∫∑c <strong>.zip</strong> ch·ª©a media files.
            C·∫•u tr√∫c b√™n trong: <code>avatars/</code>, <code>covers/</code>, <code>news/</code>, <code>knowledge/</code>, ...
        </div>
        <form id="mediaUploadForm" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 12px;">
            {% csrf_token %}
            <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Ch·ªçn file media (.tar.gz ho·∫∑c .zip):</label>
                <input type="file" name="media_file" id="mediaFile" accept=".tar.gz,.tgz,.zip"
                    style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box;">
            </div>
            <div id="mediaFileInfo" style="display: none; padding: 8px 12px; background: #f0f0f0; border-radius: 4px; font-size: 13px;"></div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button type="submit" id="mediaUploadBtn" class="default" disabled
                    style="padding: 8px 20px; opacity: 0.5;">
                    üì§ Upload Media
                </button>
                <span id="mediaUploadStatus"></span>
            </div>
        </form>
    </div>
</div>

<!-- Info -->
<div class="module">
    <h2>Th√¥ng tin</h2>
    <ul style="padding: 10px 20px; margin: 0;">
        <li>Backups ƒë∆∞·ª£c l∆∞u t·∫°i: <code>{{ backup_dir }}</code></li>
        <li>Format: PostgreSQL SQL dump</li>
        <li>Khuy·∫øn ngh·ªã backup ƒë·ªãnh k·ª≥ h√†ng ng√†y</li>
        <li>Sau khi restore, c·∫ßn <strong>restart container</strong> ƒë·ªÉ load l·∫°i SiteConfiguration</li>
    </ul>
</div>

<!-- Quick Links -->
<div class="module">
    <h2>Li√™n k·∫øt</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px 15px;">
        <a href="/admin/postgres/" style="display: inline-block; padding: 6px 14px; background: #417690; color: #fff; border-radius: 4px; text-decoration: none; font-size: 13px;">‚Üê Back to Dashboard</a>
        <a href="/admin/postgres/tables/" style="display: inline-block; padding: 6px 14px; background: #417690; color: #fff; border-radius: 4px; text-decoration: none; font-size: 13px;">Browse Tables</a>
    </div>
</div>

<script>
document.getElementById('backupForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('createBackupBtn');
    const status = document.getElementById('backupStatus');
    
    btn.disabled = true;
    btn.value = 'ƒêang t·∫°o backup...';
    status.textContent = '';
    
    fetch('/admin/postgres/backup/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (response.ok) {
            // Download the file
            return response.blob().then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const disposition = response.headers.get('Content-Disposition');
                const filename = disposition ? disposition.split('filename=')[1].replace(/"/g, '') : 'backup.sql';
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                
                status.innerHTML = '<span style="color: green;">‚úì Backup ƒë√£ t·∫°o th√†nh c√¥ng!</span>';
                setTimeout(() => location.reload(), 2000);
            });
        } else {
            return response.json().then(data => {
                throw new Error(data.message || 'Backup failed');
            });
        }
    })
    .catch(err => {
        status.innerHTML = '<span style="color: red;">‚úó ' + err.message + '</span>';
    })
    .finally(() => {
        btn.disabled = false;
        btn.value = 'üíæ T·∫°o Backup ngay';
    });
});

function deleteBackup(filename) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a backup "' + filename + '"?')) return;
    
    fetch('/admin/postgres/backup/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({filename: filename})
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(err => alert('Error: ' + err.message));
}

// ============ Restore Functions ============

function switchRestoreTab(tab) {
    const uploadPanel = document.getElementById('restoreUpload');
    const serverPanel = document.getElementById('restoreServer');
    const tabUpload = document.getElementById('tabUpload');
    const tabServer = document.getElementById('tabServer');

    if (tab === 'upload') {
        uploadPanel.style.display = 'block';
        serverPanel.style.display = 'none';
        tabUpload.style.background = '#417690';
        tabUpload.style.color = '#fff';
        tabUpload.style.borderColor = '#417690';
        tabUpload.style.fontWeight = 'bold';
        tabServer.style.background = '#e0e0e0';
        tabServer.style.color = '#333';
        tabServer.style.borderColor = '#ccc';
        tabServer.style.fontWeight = 'normal';
    } else {
        uploadPanel.style.display = 'none';
        serverPanel.style.display = 'block';
        tabServer.style.background = '#417690';
        tabServer.style.color = '#fff';
        tabServer.style.borderColor = '#417690';
        tabServer.style.fontWeight = 'bold';
        tabUpload.style.background = '#e0e0e0';
        tabUpload.style.color = '#333';
        tabUpload.style.borderColor = '#ccc';
        tabUpload.style.fontWeight = 'normal';
    }
}

// File input change handler
document.getElementById('restoreFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const btn = document.getElementById('restoreUploadBtn');
    const info = document.getElementById('restoreFileInfo');

    if (file) {
        const sizeMB = (file.size / 1024 / 1024).toFixed(2);
        info.style.display = 'block';
        info.innerHTML = 'üìÑ <strong>' + file.name + '</strong> ‚Äî ' + sizeMB + ' MB';
        btn.disabled = false;
        btn.style.opacity = '1';
    } else {
        info.style.display = 'none';
        btn.disabled = true;
        btn.style.opacity = '0.5';
    }
});

// Upload restore form
document.getElementById('restoreUploadForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const fileInput = document.getElementById('restoreFile');
    if (!fileInput.files[0]) {
        alert('Vui l√≤ng ch·ªçn file backup');
        return;
    }

    if (!confirm('‚ö†Ô∏è B·∫†N C√ì CH·∫ÆC CH·∫ÆN?\n\nRestore s·∫Ω GHI ƒê√à to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i.\nH√£y ƒë·∫£m b·∫£o ƒë√£ backup tr∆∞·ªõc khi ti·∫øp t·ª•c.\n\nFile: ' + fileInput.files[0].name)) return;

    const btn = document.getElementById('restoreUploadBtn');
    const status = document.getElementById('restoreUploadStatus');
    const formData = new FormData();
    formData.append('backup_file', fileInput.files[0]);

    btn.disabled = true;
    btn.textContent = '‚è≥ ƒêang restore...';
    status.innerHTML = '<span style="color: #856404;">‚è≥ ƒêang restore database, vui l√≤ng ch·ªù...</span>';

    fetch('/admin/postgres/restore/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            status.innerHTML = '<span style="color: green;">‚úÖ ' + data.message + '</span>';
            setTimeout(() => location.reload(), 2000);
        } else {
            status.innerHTML = '<span style="color: red;">‚ùå ' + data.message + '</span>';
        }
    })
    .catch(err => {
        status.innerHTML = '<span style="color: red;">‚ùå L·ªói: ' + err.message + '</span>';
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'üîÑ Restore t·ª´ file upload';
    });
});

// Restore from server file
function restoreFromServer(filename) {
    if (!confirm('‚ö†Ô∏è B·∫†N C√ì CH·∫ÆC CH·∫ÆN?\n\nRestore s·∫Ω GHI ƒê√à to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i.\nH√£y ƒë·∫£m b·∫£o ƒë√£ backup tr∆∞·ªõc khi ti·∫øp t·ª•c.\n\nFile: ' + filename)) return;

    const status = document.getElementById('restoreServerStatus');
    status.innerHTML = '<span style="color: #856404;">‚è≥ ƒêang restore t·ª´ <strong>' + filename + '</strong>, vui l√≤ng ch·ªù...</span>';

    // Disable all restore buttons
    document.querySelectorAll('#restoreServer button').forEach(b => { b.disabled = true; b.style.opacity = '0.5'; });

    fetch('/admin/postgres/restore/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({filename: filename})
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            status.innerHTML = '<div style="padding: 10px; background: #d4edda; border-radius: 4px;"><strong>‚úÖ ' + data.message + '</strong><br><small>Trang s·∫Ω reload trong 2 gi√¢y...</small></div>';
            setTimeout(() => location.reload(), 2000);
        } else {
            status.innerHTML = '<div style="padding: 10px; background: #f8d7da; border-radius: 4px;"><strong>‚ùå ' + data.message + '</strong></div>';
        }
    })
    .catch(err => {
        status.innerHTML = '<div style="padding: 10px; background: #f8d7da; border-radius: 4px;"><strong>‚ùå L·ªói: ' + err.message + '</strong></div>';
    })
    .finally(() => {
        document.querySelectorAll('#restoreServer button').forEach(b => { b.disabled = false; b.style.opacity = '1'; });
    });
}
// ============ Media Upload ============

document.getElementById('mediaFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const btn = document.getElementById('mediaUploadBtn');
    const info = document.getElementById('mediaFileInfo');
    if (file) {
        const sizeMB = (file.size / 1024 / 1024).toFixed(2);
        info.style.display = 'block';
        info.innerHTML = 'üìÑ <strong>' + file.name + '</strong> ‚Äî ' + sizeMB + ' MB';
        btn.disabled = false;
        btn.style.opacity = '1';
    } else {
        info.style.display = 'none';
        btn.disabled = true;
        btn.style.opacity = '0.5';
    }
});

document.getElementById('mediaUploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('mediaFile');
    if (!fileInput.files[0]) { alert('Vui l√≤ng ch·ªçn file media'); return; }
    if (!confirm('Upload media files?\n\nFile: ' + fileInput.files[0].name + '\nC√°c file tr√πng t√™n s·∫Ω ƒë∆∞·ª£c ghi ƒë√®.')) return;

    const btn = document.getElementById('mediaUploadBtn');
    const status = document.getElementById('mediaUploadStatus');
    const formData = new FormData();
    formData.append('media_file', fileInput.files[0]);

    btn.disabled = true;
    btn.textContent = '‚è≥ ƒêang upload...';
    status.innerHTML = '<span style="color: #856404;">‚è≥ ƒêang upload v√† gi·∫£i n√©n media...</span>';

    fetch('/admin/postgres/media/upload/', {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            status.innerHTML = '<span style="color: green;">‚úÖ ' + data.message + '</span>';
        } else {
            status.innerHTML = '<span style="color: red;">‚ùå ' + data.message + '</span>';
        }
    })
    .catch(err => {
        status.innerHTML = '<span style="color: red;">‚ùå L·ªói: ' + err.message + '</span>';
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'üì§ Upload Media';
    });
});
</script>
{% endblock %}
