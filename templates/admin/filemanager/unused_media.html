{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}{{ title }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="/admin/">Trang ch·ªß</a> &rsaquo;
  <a href="{% url 'filemanager:file_browser' %}">File Manager</a> &rsaquo;
  {{ title }}
</div>
{% endblock %}

{% block content %}

<style>
  .scan-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding: 20px 24px;
    background: linear-gradient(135deg, #1e3a5f, #2d5a87);
    border-radius: 12px;
    color: white;
  }
  .scan-header h2 { margin: 0; font-size: 20px; }
  .scan-header .stats {
    display: flex;
    gap: 24px;
    font-size: 14px;
  }
  .scan-header .stat-item {
    text-align: center;
  }
  .scan-header .stat-value {
    font-size: 28px;
    font-weight: 700;
  }
  .scan-header .stat-label {
    opacity: 0.8;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .actions-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding: 12px 16px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }
  .actions-bar .left { display: flex; align-items: center; gap: 12px; }
  .actions-bar .right { display: flex; align-items: center; gap: 8px; }

  .btn-delete {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
  }
  .btn-delete:hover { background: #c82333; transform: translateY(-1px); }
  .btn-delete:disabled { background: #cbd5e0; cursor: not-allowed; transform: none; }

  .btn-scan {
    background: #2d5a87;
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
    text-decoration: none;
    transition: all 0.2s;
  }
  .btn-scan:hover { background: #1e3a5f; color: white; transform: translateY(-1px); }

  .select-actions { display: flex; gap: 8px; align-items: center; }
  .select-actions a {
    font-size: 12px;
    color: #2d5a87;
    cursor: pointer;
    text-decoration: underline;
  }

  .folder-section {
    margin-bottom: 24px;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    overflow: hidden;
    background: white;
  }
  .folder-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #f1f5f9;
    border-bottom: 1px solid #e2e8f0;
    cursor: pointer;
    user-select: none;
  }
  .folder-header:hover { background: #e8edf3; }
  .folder-header h3 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .folder-meta {
    font-size: 12px;
    color: #64748b;
    display: flex;
    gap: 12px;
  }

  .file-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    padding: 16px;
  }

  .file-card {
    position: relative;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.2s;
    background: white;
  }
  .file-card:hover { border-color: #93c5fd; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .file-card.selected { border-color: #dc3545; background: #fff5f5; }

  .file-card .preview {
    width: 100%;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8fafc;
    overflow: hidden;
    position: relative;
  }
  .file-card .preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover;
    width: 100%;
    height: 100%;
  }
  .file-card .preview .file-icon {
    font-size: 36px;
    color: #94a3b8;
  }

  .file-card .checkbox-area {
    position: absolute;
    top: 6px;
    left: 6px;
    z-index: 2;
  }
  .file-card .checkbox-area input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #dc3545;
  }

  .file-card .info {
    padding: 8px 10px;
  }
  .file-card .info .filename {
    font-size: 11px;
    font-weight: 500;
    color: #334155;
    word-break: break-all;
    line-height: 1.3;
    max-height: 2.6em;
    overflow: hidden;
  }
  .file-card .info .filesize {
    font-size: 10px;
    color: #94a3b8;
    margin-top: 3px;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
  }
  .empty-state .icon { font-size: 60px; margin-bottom: 16px; }
  .empty-state h3 { margin: 0 0 8px; color: #1e293b; }

  .selected-count {
    font-size: 13px;
    font-weight: 600;
    color: #dc3545;
    min-width: 80px;
  }
  .filter-bar {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 16px;
  }
  .filter-bar input {
    padding: 6px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 13px;
    width: 250px;
  }
</style>

{% if total_count == 0 %}
  <div class="empty-state">
    <div class="icon">‚úÖ</div>
    <h3>Kh√¥ng c√≥ media file kh√¥ng s·ª≠ d·ª•ng!</h3>
    <p>T·∫•t c·∫£ c√°c file trong th∆∞ m·ª•c media ƒë·ªÅu ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng.</p>
    <a href="{% url 'filemanager:unused_media' %}" class="btn-scan" style="display:inline-block; margin-top:16px;">üîÑ Qu√©t l·∫°i</a>
  </div>
{% else %}

<form method="post" id="deleteForm">
{% csrf_token %}

  <div class="scan-header">
    <div>
      <h2>üóëÔ∏è Media Kh√¥ng S·ª≠ D·ª•ng</h2>
      <p style="margin:6px 0 0; opacity:0.85; font-size:13px;">
        C√°c file d∆∞·ªõi ƒë√¢y t·ªìn t·∫°i tr√™n server nh∆∞ng kh√¥ng ƒë∆∞·ª£c tham chi·∫øu trong b√†i vi·∫øt, b·∫£n ghi n√†o.
      </p>
    </div>
    <div class="stats">
      <div class="stat-item">
        <div class="stat-value">{{ total_count }}</div>
        <div class="stat-label">File</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ total_size_display }}</div>
        <div class="stat-label">Dung l∆∞·ª£ng</div>
      </div>
    </div>
  </div>

  <div class="actions-bar">
    <div class="left">
      <div class="select-actions">
        <a onclick="selectAll()">‚úÖ Ch·ªçn t·∫•t c·∫£</a>
        <a onclick="deselectAll()">‚ùé B·ªè ch·ªçn</a>
        <a onclick="selectFolder()">üìÅ Ch·ªçn theo th∆∞ m·ª•c</a>
      </div>
      <span class="selected-count" id="selectedCount">0 file ƒë√£ ch·ªçn</span>
    </div>
    <div class="right">
      <input type="text" id="filterInput" placeholder="üîç T√¨m theo t√™n file..." onkeyup="filterFiles()">
      <button type="submit" class="btn-delete" id="deleteBtn" disabled
              onclick="return confirm('‚ö†Ô∏è Xo√° vƒ©nh vi·ªÖn ' + getSelectedCount() + ' file ƒë√£ ch·ªçn?\n\nH√†nh ƒë·ªông n√†y KH√îNG th·ªÉ ho√†n t√°c!')">
        üóëÔ∏è Xo√° file ƒë√£ ch·ªçn
      </button>
      <a href="{% url 'filemanager:unused_media' %}" class="btn-scan">üîÑ Qu√©t l·∫°i</a>
    </div>
  </div>

  {% for folder_name, folder_data in folders.items %}
  <div class="folder-section" data-folder="{{ folder_name }}">
    <div class="folder-header" onclick="toggleFolder('{{ folder_name }}')">
      <h3>
        <span class="toggle-icon" id="icon-{{ folder_name }}">‚ñº</span>
        üìÅ {{ folder_name }}/
      </h3>
      <div class="folder-meta">
        <span>{{ folder_data.count }} file</span>
        <span>‚Ä¢</span>
        <span>{{ folder_data.size_display }}</span>
        <span>‚Ä¢</span>
        <a onclick="event.stopPropagation(); selectByFolder('{{ folder_name }}')" style="color:#2d5a87; text-decoration:underline; cursor:pointer;">Ch·ªçn th∆∞ m·ª•c</a>
      </div>
    </div>
    <div class="file-grid" id="grid-{{ folder_name }}">
      {% for file in folder_data.files %}
      <div class="file-card" data-folder="{{ folder_name }}" data-filename="{{ file.filename|lower }}">
        <div class="checkbox-area">
          <input type="checkbox" name="selected_files" value="{{ file.rel_path }}" onchange="updateCount()">
        </div>
        <div class="preview">
          {% if file.filename|lower|slice:"-4:" == ".webp" or file.filename|lower|slice:"-4:" == ".jpg" or file.filename|lower|slice:"-4:" == ".png" or file.filename|lower|slice:"-4:" == ".gif" or file.filename|lower|slice:"-5:" == ".jpeg" or file.filename|lower|slice:"-4:" == ".svg" %}
            <img src="/media/{{ file.rel_path }}" alt="{{ file.filename }}" loading="lazy">
          {% elif file.filename|lower|slice:"-4:" == ".mp4" or file.filename|lower|slice:"-5:" == ".webm" %}
            <div class="file-icon">üé¨</div>
          {% elif file.filename|lower|slice:"-4:" == ".mp3" or file.filename|lower|slice:"-4:" == ".wav" %}
            <div class="file-icon">üéµ</div>
          {% elif file.filename|lower|slice:"-4:" == ".pdf" %}
            <div class="file-icon">üìÑ</div>
          {% else %}
            <div class="file-icon">üìé</div>
          {% endif %}
        </div>
        <div class="info">
          <div class="filename" title="{{ file.rel_path }}">{{ file.filename }}</div>
          <div class="filesize">{{ file.size_display }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endfor %}

</form>

<script>
function getSelectedCount() {
  return document.querySelectorAll('input[name="selected_files"]:checked').length;
}

function updateCount() {
  const count = getSelectedCount();
  document.getElementById('selectedCount').textContent = count + ' file ƒë√£ ch·ªçn';
  document.getElementById('deleteBtn').disabled = count === 0;

  // Update card selected visual
  document.querySelectorAll('.file-card').forEach(card => {
    const cb = card.querySelector('input[type="checkbox"]');
    card.classList.toggle('selected', cb && cb.checked);
  });
}

function selectAll() {
  document.querySelectorAll('input[name="selected_files"]').forEach(cb => {
    if (cb.closest('.file-card').style.display !== 'none') cb.checked = true;
  });
  updateCount();
}

function deselectAll() {
  document.querySelectorAll('input[name="selected_files"]').forEach(cb => cb.checked = false);
  updateCount();
}

function selectByFolder(folder) {
  document.querySelectorAll('.file-card[data-folder="' + folder + '"] input[type="checkbox"]').forEach(cb => {
    if (cb.closest('.file-card').style.display !== 'none') cb.checked = true;
  });
  updateCount();
}

function selectFolder() {
  const folder = prompt('Nh·∫≠p t√™n th∆∞ m·ª•c mu·ªën ch·ªçn (VD: news, knowledge, covers):');
  if (folder) selectByFolder(folder.trim());
}

function toggleFolder(folder) {
  const grid = document.getElementById('grid-' + folder);
  const icon = document.getElementById('icon-' + folder);
  if (grid.style.display === 'none') {
    grid.style.display = 'grid';
    icon.textContent = '‚ñº';
  } else {
    grid.style.display = 'none';
    icon.textContent = '‚ñ∂';
  }
}

function filterFiles() {
  const query = document.getElementById('filterInput').value.toLowerCase();
  document.querySelectorAll('.file-card').forEach(card => {
    const name = card.dataset.filename || '';
    card.style.display = name.includes(query) ? '' : 'none';
  });
  // Show/hide folder sections if all files hidden
  document.querySelectorAll('.folder-section').forEach(section => {
    const visible = section.querySelectorAll('.file-card:not([style*="display: none"])').length;
    section.style.display = visible > 0 ? '' : 'none';
  });
}
</script>

{% endif %}

{% endblock %}
